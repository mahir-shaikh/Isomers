!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){"use strict";!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.jsCalc=e()}(void 0,function(){function t(t){return t}function e(t){for(var e=0,r=0;r<t.length;r++)e+=t[r];return e/t.length}function r(t){alert("Error: "+t.toString())}window.isArray||(window.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var n={};n.makeValue=function(t){switch(typeof t){case"string":return e="TRUE"==t.toUpperCase()||"FALSE"==t.toUpperCase()?new n.jsCalcBooleanValue(t):parseFloat(t)&&!isNaN(Number(t))?new n.jsCalcNumValue(parseFloat(t)):new n.jsCalcStringValue(t);case"number":return e=new n.jsCalcNumValue(parseFloat(t));case"boolean":var e=new n.jsCalcBooleanValue(t);return e;default:return-1}},n.NumValue=function(e){return e=t(e),new n.jsCalcNumValue(e)},n.ReferenceValue=function(t,e,r,a,i,o){return new n.jsCalcReferenceValue(t,e,r,a,i,o)},n.BooleanValue=function(t){return new n.jsCalcBooleanValue(t)},n.StringValue=function(t){return new n.jsCalcStringValue(t)},n.ErrorValue=function(t,e,r){return new n.jsCalcErrorValue(t,e,r)},n.jsCalcBooleanValue=function(t){t.toUpperCase?"FALSE"==t.toUpperCase()?this.data=!1:"TRUE"==t.toUpperCase()?this.data=!0:this.data=!!t:this.data=!!t},n.jsCalcBooleanValue.prototype.num=function(t){return this.data?1:0},n.jsCalcBooleanValue.prototype.b=function(t){return this.data},n.jsCalcBooleanValue.prototype.s=function(t){return this.data?"True":"False"},n.jsCalcBooleanValue.prototype.v=function(t){return 1==this.data},n.jsCalcBooleanValue.prototype.each=function(t,e){t.call(this,e)},n.jsCalcBooleanValue.prototype.eachCell=function(t,e){t.call(this,e)},n.jsCalcBooleanValue.prototype.isBlank=!1,n.jsCalcNumValue=function(t){this.data=t},n.jsCalcNumValue.prototype.num=function(t){return this.data},n.jsCalcNumValue.prototype.b=function(t){return!!this.data},n.jsCalcNumValue.prototype.s=function(t){return this.data.toString()},n.jsCalcNumValue.prototype.v=function(t){return this.data},n.jsCalcNumValue.prototype.each=function(t,e){t.call(this,e)},n.jsCalcNumValue.prototype.eachCell=function(t,e){t.call(this,e)},n.jsCalcNumValue.prototype.isBlank=!1,n.jsCalcReferenceValue=function(t,e,r,a,i,o,s){i||alert("set cellCtx in caller"),this.startRow=parseInt(t),this.startCol=parseInt(e),this.endRow=parseInt(r||t),this.endCol=parseInt(a||e),this.h=this.endRow-this.startRow+1,this.w=this.endCol-this.startCol+1,this.count=this.h*this.w,1==this.h?this.index=n.jsCalcReferenceValue.colIndex:1==this.w?this.index=n.jsCalcReferenceValue.rowIndex:this.index=n.jsCalcReferenceValue.fullIndex,s&&(this.targetSheetOb=s),!this.targetSheetOb&&o&&(this.targetSheetOb=i.workbook.worksheets[o]),!this.targetSheetOb&&i.worksheet&&(this.targetSheetOb=i.worksheet),this.targetSheetOb||console.log("Didn't manage to find a worksheet reference for:",o,"!R"+t+"C"+r),this.startRow==this.endRow&&this.startCol==this.endCol?(this.num=function(t){var e=this.getSingleCellReference();return e.value.errorContext?e.value.num(t):e.value.num(e)},this.b=function(t){var e=this.getSingleCellReference();return e.value.errorContext?e.value.b(t):e.value.b(e)},this.s=function(t){var e=this.getSingleCellReference();return e.value.errorContext?e.value.s(t):e.value.s(e)},this.v=function(t){var e=this.getSingleCellReference();if(e.value.errorContext)return e.value.v(t);if(e===t)throw new Error("Infinite loop evaluating cell");return e.value.v(e)}):(this.num=function(t){return this.getReference(t).num(t)},this.b=function(t){return this.getReference(t).b(t)},this.s=function(t){return this.getReference(t).s(t)},this.v=function(t){return this.getReference(t).v(t)})},n.jsCalcReferenceValue.prototype.setValue=function(t){window.isArray(t)||this.getSingleCellReference().setValue(t)},n.jsCalcReferenceValue.prototype.get=function(t){var e=1+Math.floor(t/this.w),r=1+t%this.w;return new n.jsCalcReferenceValue(this.startRow+e-1,this.startCol+r-1,this.startRow+e-1,this.startCol+r-1,this.targetSheetOb.getCell(this.startRow+e-1,this.startCol+r-1),this.targetSheetOb.name,this.targetSheetOb)},n.jsCalcReferenceValue.prototype.getByIndex=function(t,e){return new n.jsCalcReferenceValue(this.startRow+t-1,this.startCol+e-1,this.startRow+t-1,this.startCol+e-1,this.targetSheetOb.getCell(this.startRow+t-1,this.startCol+e-1),this.targetSheetOb.name,this.targetSheetOb)},n.jsCalcReferenceValue.prototype.getCellByIndex=function(t,e){return this.targetSheetOb.getCell(this.startRow+t,this.startCol+e)},n.jsCalcReferenceValue.prototype.resize=function(t,e){return new n.jsCalcReferenceValue(this.startRow,this.startCol,this.startRow+t-1,this.startCol+e-1,this.targetSheetOb.getCell(this.startRow,this.startCol),this.targetSheetOb.name,this.targetSheetOb)},n.jsCalcReferenceValue.prototype.address=function(){var t=this.targetSheetOb.name+"!R"+this.startRow+"C"+this.startCol;return this.startRow==this.endRow&&this.startCol==this.endCol||(t+=":R"+this.endRow+"C"+this.endCol),t},n.jsCalcReferenceValue.prototype.getReference=function(t){return 1==this.h&&1==this.w?this:t.row>=this.startRow&&t.row<=this.endRow&&this.startCol==this.endCol?this.targetSheetOb.getCell(t.row,this.startCol):t.col>=this.startCol&&t.col<=this.endCol&&this.startRow==this.endRow?this.targetSheetOb.getCell(this.startRow,t.col):n.ErrorValue(n.jsCalcErrorValue.value,t)},n.jsCalcReferenceValue.prototype.getReferenceAsValueReference=function(t){return 1==this.h&&1==this.w?this:t.row>=this.startRow&&t.row<=this.endRow&&this.startCol==this.endCol?n.ReferenceValue(t.row,this.startCol,t.row,this.startCol,t,this.targetSheetOb.name):t.col>=this.startCol&&t.col<=this.endCol&&this.startRow==this.endRow?n.ReferenceValue(this.startRow,t.col,this.startRow,t.col,t,this.targetSheetOb.name):n.ErrorValue(n.jsCalcErrorValue.value,t)},n.jsCalcReferenceValue.prototype.each=function(t,e){for(var r=this.startRow;r<=this.endRow;r++)for(var a=this.startCol;a<=this.endCol;a++)t.call(new n.jsCalcReferenceValue(r,a,r,a,this.targetSheetOb.getCell(r,a),this.targetSheetOb.name,this.targetSheetOb))},n.jsCalcReferenceValue.prototype.eachCell=function(t,e){for(var r=this.startRow;r<=this.endRow;r++)for(var n=this.startCol;n<=this.endCol;n++){var a=this.targetSheetOb?this.targetSheetOb.getCell(r,n):null;a&&t.call(a)}},n.jsCalcReferenceValue.prototype.valueArray=function(){for(var t=[],e=this.startRow;e<=this.endRow;e++){for(var r=[],n=this.startCol;n<=this.endCol;n++)r.push(this.targetSheetOb.getCell(e,n).v());t.push(r)}return t},n.jsCalcReferenceValue.fullIndex=function(t,e,r){return new n.jsCalcReferenceValue(this.startRow+t-1,this.startCol+e-1,this.startRow+t-1,this.startCol+e-1,this.targetSheetOb.getCell(this.startRow+t-1,this.startCol+e-1),this.targetSheetOb.name,this.targetSheetOb)},n.jsCalcReferenceValue.rowIndex=function(t,e){return t<=this.h?new n.jsCalcReferenceValue(this.startRow+t-1,this.startCol,this.startRow+t-1,this.startCol,this.targetSheetOb.getCell(this.startRow+t-1,this.startCol),this.targetSheetOb.name,this.targetSheetOb):n.ErrorValue(n.jsCalcErrorValue.value,e,"Attempted an out of bounds index")},n.jsCalcReferenceValue.colIndex=function(t,e,r){return r||(r=e,e=t),e<=this.w?new n.jsCalcReferenceValue(this.startRow,this.startCol+e-1,this.startRow,this.startCol+e-1,this.targetSheetOb.getCell(this.startRow,this.startCol+e-1),this.targetSheetOb.name,this.targetSheetOb):n.ErrorValue(n.jsCalcErrorValue.value,r,"Attempted an out of bounds index")},n.jsCalcReferenceValue.prototype.getSingleCellReference=function(t){return this.targetSheetOb.getCell(this.startRow,this.startCol)},n.jsCalcStringValue=function(t){this.data=t},n.jsCalcStringValue.prototype.num=function(t){var e=isNaN(Number(this.data))?this.data:parseFloat(this.data);return this.data.length>0?e:0},n.jsCalcStringValue.prototype.b=function(t){return"TRUE"==this.data.toUpper()},n.jsCalcStringValue.prototype.s=function(t){return this.data},n.jsCalcStringValue.prototype.v=function(t){return this.data},n.jsCalcStringValue.prototype.each=function(t,e){t.call(this)},n.jsCalcStringValue.prototype.eachCell=function(t,e){t.call(this)},n.jsCalcStringValue.prototype.isBlank=!1,n.jsCalcErrorValue=function(t,e,r){this.data=t,this.errorContext=e,this.text=r,e.errorStatus||(e.errorStatus=this)},n.jsCalcErrorValue.uninitialized="#UNINITIALIZED!",n.jsCalcErrorValue.ref="#REF!",n.jsCalcErrorValue.divideByZero="#DIV/0!",n.jsCalcErrorValue.nameErr="#NAME!",n.jsCalcErrorValue.num="#NUM!",n.jsCalcErrorValue.calc="#CALCERROR!",n.jsCalcErrorValue.value="#VALUE!",n.jsCalcErrorValue.build=-5,n.jsCalcErrorValue.na="#N/A",n.jsCalcErrorValue.prototype.num=function(t){return t&&(!t.errorStatus||t.errorStatus&&!t.errorStatus.errorContext)&&(t.errorStatus=this),this.data},n.jsCalcErrorValue.prototype.b=function(t){return t&&(!t.errorStatus||t.errorStatus&&!t.errorStatus.errorContext)&&(t.errorStatus=this),this.data},n.jsCalcErrorValue.prototype.s=function(t){return t&&(!t.errorStatus||t.errorStatus&&!t.errorStatus.errorContext)&&(t.errorStatus=this),this.data.toString()},n.jsCalcErrorValue.prototype.index=function(){return this},n.jsCalcErrorValue.prototype.v=function(t){return this},n.jsCalcErrorValue.prototype.toString=function(){return this.data},n.jsCalcErrorValue.prototype.each=function(t,e){t.call(this)},n.jsCalcErrorValue.prototype.eachCell=function(t,e){},n.jsCalcMulticellReferenceValue=function(t,e){this.refs=[];for(var r=0;r<t.length;r++){var a=t[r];this.refs.push(n.ReferenceValue(a.startRow,a.startCol,a.endRow,a.endCol,e,a.sheetName))}},n.jsCalcMulticellReferenceValue.prototype.each=function(t,e){for(var r=0;r<this.refs.length;r++)this.refs[r].each(t,e)};var a={};a.sqrt2PI=Math.sqrt(2*Math.PI),a.recipSqrt2PI=1/Math.sqrt(2*Math.PI),a.SUM=function(t,e){for(var r=0,a=e,i=0;i<t.length;i++){(0,t[i])(e);t[i](e).each(function(){r+=this.num(a)})}return n.NumValue(r)},a.PRODUCT=function(t,e){for(var r=1,a=e,i=0;i<t.length;i++){(0,t[i])(e);t[i](e).each(function(){r*=""!=this.s(e)?this.num(a):1})}return n.NumValue(r)},a.IF=function(t,e){return t[0](e).b(e)?t[1](e):t[2]?t[2](e):n.NumValue(0)},a.LARGE=function(t,e){var r=[],a=(t[0](e),Math.floor(t[1](e).num(e))),i=e;return t[0](e).each(function(){r.push(this.num(i))}),r=r.sort(function(t,e){return e<t?-1:e>t?1:0}),a>r.length?n.ErrorValue(n.jsCalcErrorValue.num,e,"LARGE had index greater than array size"):n.NumValue(r[a-1])},a.NOT=function(t,e){var r=t[0](e).b(e);t[0](e).v();return n.BooleanValue(!r)},a.ROW=function(t,e){var r=t[0](e).index(1,1).getSingleCellReference().row;if(r)return n.NumValue(r)},a.INDEX=function(t,e){var r=t[0](e),n=t[1](e).num(e);if(t[2]){var a=t[2](e).num(e);return 1==r.h?r.index(a,e):1==r.w?r.index(n,e):r.index(n,a,e)}return r.index(n,e)},a.ISERROR=function(t,e){return t[0](e).v(e).errorContext?n.BooleanValue(!0):n.BooleanValue(!1)},a.ISBLANK=function(t,e){var r=t[0](e).v();return n.BooleanValue(!r)},a.IFERROR=function(t,e){return t[0](e).v(e).errorContext?(e.errorStatus=null,t[1](e)):t[0](e)},a.VLOOKUP=function(t,e){var r=!1;t[3]&&(r=!t[3](e).b(e));var a=t[2](e).num(e),i=t[1](e);if(r)for(var o=null,s=t[0](e).s(e),u=!isNaN(s),l=0;l<i.h;l++){var c=i.index(1+l,1).getSingleCellReference();if(!c.isBlank){var h=c.s(),f=!isNaN(h);if(u||f){if(h==s){o=i.index(1+l,a);break}}else if(h.toLowerCase()==s.toLowerCase()){o=i.index(1+l,a);break}}}else{var o=null,g=null,s=t[0](e).num(e);(u=!isNaN(s))||(s=t[0](e).s(e));for(l=0;l<i.h;l++){h=i.index(l+1,1).num(e);if(!(f=!isNaN(h)))h=i.index(l+1,1).s(e);if(u||f){if(h==s){o=i.index(l+1,a);break}if(h>s){o=g;break}}else if(h.toLowerCase()>s.toLowerCase()){o=i.index(l,a);break}g=i.index(l+1,a)}null==o&&(o=i.index(i.h,a))}return o||n.ErrorValue(n.jsCalcErrorValue.na,e,"VLOOKUP didn't find valid result")},a.HLOOKUP=function(t,e){var r=!1;t[3]&&(r=!t[3](e).b(e));var a=t[2](e).num(e),i=t[1](e);if(r)for(var o=null,s=t[0](e).s(e),u=!isNaN(s),l=0;l<i.w;l++){var c=i.index(1,1+l).getSingleCellReference();if(!c.isBlank){var h=c.s(),f=!isNaN(h);if(u||f){if(h==s){o=i.index(a,1+l);break}}else if(h.toLowerCase()==s.toLowerCase()){o=i.index(a,1+l);break}}}else{var o=null,g=null,s=t[0](e).num(e);(u=!isNaN(s))||(s=t[0](e).s(e));for(l=0;l<i.w;l++){h=i.index(1,1+l).num(e);if(!(f=!isNaN(h)))h=i.index(1,l+1).s(e);if(u||f){if(h==s){o=i.index(a,l+1);break}if(h>s){o=g;break}}else if(h.toLowerCase()>s.toLowerCase()){o=i.index(a,l);break}g=i.index(a,l+1)}null==o&&(o=i.index(a,i.w))}return o||n.ErrorValue(n.jsCalcErrorValue.na,e,"HLOOKUP didn't find valid result")},a.ABS=function(t,e){return n.NumValue(Math.abs(t[0](e).num(e)))},a.AND=function(t,e){for(var r=!0,a=e,i=0;i<t.length;i++)(0,t[i])(e),t[i](e).each(function(){r=r&&this.b(a)});return n.BooleanValue(r)},a.OR=function(t,e){for(var r=!1,a=e,i=0;i<t.length;i++)(0,t[i])(e),t[i](e).each(function(){r=r||this.b(a)});return n.BooleanValue(r)},a.IFNA=function(t,e){return t[0](e).v(e).errorContext?(e.errorStatus=null,t[1](e)):t[0](e)},a.AVERAGE=function(t,e){for(var r=0,a=0,i=e,o=0;o<t.length;o++)(0,t[o])(e),t[o](e).each(function(){a+=1,r+=this.num(i)});return n.NumValue(r/a)},a.CHOOSE=function(t,e){return t[t[0](e).num(e)](e)};var i={};i.createConditionFunction=function(t){if(t.s){var e=t;return function(t,r){return t.s(r)==e.s(r)}}if("TRUE"==t.toUpperCase()||"=TRUE"==t.toUpperCase())return function(t,e){return t.b(e)};if("FALSE"==t.toUpperCase()||"=FALSE"==t.toUpperCase())return function(t,e){return!t.b(e)};var r=/^(\=|\<\=|\>\=|\<\>|\<|\>)*([0-9\.]+)$/i;if(!r.test(t)){var n=t;return function(t,e){return t.s(e)==n}}var a=r.exec(t),i=parseFloat(a[2]);switch(a[1]){case"<":return function(t,e){return t.num(e)<i};case">":return function(t,e){return t.num(e)>i};case">=":return function(t,e){return t.num(e)>=i};case"<=":return function(t,e){return t.num(e)<=i};case"<>":return function(t,e){return t.num(e)!=i};case"=":default:return function(t,e){return t.num(e)==i}}},a.COUNTIF=function(t,e){var r=e,a=(t[1](e),t[0](e));a.each(function(){Number(this.num(r))});t[0](e);var o=t[1](e).s(e),s=i.createConditionFunction(o),u=0;(0,t[0])(e);(a=t[0](e)).each(function(){Number(this.num(r))});a.each(function(){s(this,e)&&(u+=1)});return n.NumValue(u)},a.SUMIF=function(t,e){var r=t[0](e),a=t[1](e).s(e),o=i.createConditionFunction(a),s=0;if(t[2])for(var u=t[2](e),l=r.count>u.count?u.count:r.count,c=0;c<l;c++)o(h=r.get(c),e)&&(s+=u.get(c).num(e));else for(c=0;c<r.count;c++){var h=r.get(c);o(h,e)&&(s+=h.num(e))}return n.NumValue(s)},a.MATCH=function(t,e){var r=t[0](e),a=t[1](e),i=t[2]?t[2](e).num(e):0;if(i<0){for(o=0;o<a.count;o++){(s=a.get(o)).num(e);if(r.num(e)==s.num(e))return n.NumValue(o+1);if(r.num(e)>s.num(e)){if(0==o)break;return n.NumValue(o)}}if(r.num(e)<s.num(e)&&0!=o)return n.NumValue(o)}else if(i>0){for(o=0;o<a.count;o++){(s=a.get(o)).num(e);if(s.num(e)>r.num(e)){if(0==o)break;return n.NumValue(o)}}if(r.num(e)>=s.num(e)&&0!=o)return n.NumValue(o)}else for(var o=0;o<a.count;o++){var s=a.get(o);s.num(e);if(s.s(e)==r.s(e))return n.NumValue(o+1)}return n.ErrorValue(n.jsCalcErrorValue.na,e,"Match didn't find valid result")},a.MAX=function(t,e){for(var r=n.NumValue(-99999999999999),a=e,i=0;i<t.length;i++){(0,t[i])(e);var o=t[i](e);o instanceof calcCell&&(o=o.value),o.eachCell(function(){this.isBlank||(r=this.num(a)>r.num(a)?this:r)})}return r},a.MIN=function(t,e){for(var r=n.NumValue(99999999999999),a=e,i=0;i<t.length;i++){(0,t[i])(e);var o=t[i](e);o instanceof calcCell&&(o=o.value),o.eachCell(function(){this.isBlank||(r=this.num(a)<r.num(a)?this:r)})}return r},a.NA=function(t,e){return n.ErrorValue(n.jsCalcErrorValue.na,e,"NA Function Manually Called")},a.NORMDIST=function(t,e){var r=t[0](e).num(e),i=t[1](e).num(e),o=t[2](e).num(e),s=t[3](e).b(e),u=1/o,l=function(t){var e=(t-i)/o,r=-.5*e*e;return Math.pow(Math.E,r)*a.recipSqrt2PI*u};if(s){var c,h=0,f=5e3,g=o/(f/5);for(c=r;f>0;)h+=l(c)*g,c-=g,f-=1;return l(r),n.NumValue(h)}return n.NumValue(l(r))},a.NETWORKDAYS=function(t,e){for(var r=s(t[0](e).num(e)),a=s(t[1](e).num(e)),i=new Date(r),o=new Date(a),u=t.length>2,l=u?t[2](e).count:0,c=u?t[2](e):0,h=[],f=0;f<l;f++){var g=new Date(s(c.get(f).num(e)));g.setHours(12),g.setMinutes(0),g.setSeconds(0),h.push(g.valueOf())}i.setHours(12),i.setMinutes(0),i.setSeconds(0),o.setHours(12),o.setMinutes(0),o.setSeconds(0);for(var d=0,p=i;p<=o;){for(var C=p.getDay(),v=!1,f=0;f<l&&!(v=u&&h[f]==p.valueOf());f++);6==C||0==C||v||d++,p.setDate(p.getDate()+1),p.setHours(12),p.setMinutes(0),p.setSeconds(0)}return n.NumValue(d)},a.NOW=function(t,e){return n.NumValue(o(Date.now()))},a.DAY=function(t,e){var r=t[0](e).num(e),a=new Date;return a.setTime(s(r)),n.NumValue(a.getDate())},a.DATE=function(t,e){var r=t[0](e).num(e),a=t[1](e).num(e),i=t[2](e).num(e),s=new Date;return s.setMonth(a-1),s.setFullYear(r),s.setDate(i),n.NumValue(o(s.getTime()))},a.MONTH=function(t,e){var r=t[0](e).num(e),a=new Date;return a.setTime(s(r)),n.NumValue(a.getMonth()+1)},a.EOMONTH=function(t,e){var r=t[0](e).num(e),a=t.length>1?t[1](e).num(e):0,i=new Date;i.setTime(s(r));i.getFullYear();var u=i.getMonth(),l=(i.getDate(),u+a+1);i.setMonth(l),i.setDate(1);var c=i.getTime();return c-=864e5,i.setTime(c),n.NumValue(o(i.getTime()))},a.YEAR=function(t,e){var r=t[0](e).num(e),a=new Date;return a.setTime(s(r)),n.NumValue(a.getFullYear())},a.WEEKDAY=function(t,e){var r=t[0](e).num(e),a=new Date;return a.setTime(s(r)),n.NumValue(a.getDay()+1)},Date.prototype.getWeek=function(t){var e=7;switch(t){case 1:e=7;break;case 2:case 11:e=1;break;case 12:e=2;break;case 13:e=3;break;case 14:e=4;break;case 15:e=5;break;case 16:e=6;break;case 17:e=7;break;case 21:e=1;break;default:e=7}var r=new Date(this.valueOf()),n=(this.getDay()+6)%7;r.setDate(r.getDate()-n+3);var a=r.valueOf();return r.setMonth(0,1),r.getDay()!=e&&r.setMonth(0,1+(e-r.getDay()+7)%7),1+Math.ceil((a-r)/6048e5)},a.WEEKNUM=function(t,e){var r=t[0](e).num(e),a=new Date;a.setTime(s(r));var i=t.length>2?t[2](e).num(e):1;return n.NumValue(a.getWeek(i))};var o=function(t){return t/86400/1e3+25568},s=function(t){return 86400*(t-25568)*1e3};a.STDEVP=function(t,e){for(var r=0,a=0,i=0,o=(t[0](e),e),s=0;s<t.length;s++)(u=t[s](e)).each(function(){r+=this.num(o),a+=1});r/=a;for(s=0;s<t.length;s++){var u=t[s](e);u.each(function(){i+=Math.pow(this.num(o)-r,2)})}i=i/=a;var l=Math.sqrt(i);return n.NumValue(l)},a.SUMPRODUCT=function(t,e){var r=t[0](e),i=0;if(!t[1])return a.SUM(t,e);for(var o=t[1](e),s=r.count>o.count?o.count:r.count,u=0;u<s;u++)i+=r.get(u).num(e)*o.get(u).num(e);return n.NumValue(i)},a.FLOOR=function(t,e){var r=t[0](e).num(e),a=1;return t[1]&&(a=t[1](e).num(e)),r-=r%a,n.NumValue(r)},a.ROUND=function(t,e){var r=t[0](e).num(e),a=0;t[1]&&(a=t[1](e).num(e));var i=Math.pow(10,a);return r*=i,r=Math.round(r),r/=i,n.NumValue(r)},a.ROUNDDOWN=function(t,e){var r=t[0](e).num(e),a=0;t[1]&&(a=t[1](e).num(e));var i=Math.pow(10,a);return r*=i,r=Math.floor(r),r/=i,n.NumValue(r)},a.ROUNDUP=function(t,e){var r=t[0](e).num(e),a=0;t[1]&&(a=t[1](e).num(e));var i=Math.pow(10,a);return r*=i,r=Math.ceil(r),r/=i,n.NumValue(r)},a.RANK=function(t,e){var r=t[0](e).num(e),a=t[1](e),i=0;t[2]&&(i=t[2](e).num(e));for(var o=0,s=0,u=0;u<a.count;u++){var l=a.get(u).num(e);l>r?o++:l<r&&s++}return i?n.NumValue(s+1):n.NumValue(o+1)},a.OFFSET=function(t,e){var r=t[0](e),a=t[1](e).num(e),i=t[2](e).num(e),o=t[3]?t[3](e).num(e):0;o=o>0?o-1:o<0?o+1:o;var s=t[4]?t[4](e).num(e):0;s=s>0?s-1:s<0?s+1:s;var u=r.startRow+a||0,l=r.startCol+i||0,c=u+o||0,h=l+s||0,f=r.targetSheetOb.name||"";return n.ReferenceValue(u,l,c,h,e,f)},a.NPV=function(t,e){for(var r=t[0](e).num(e),a=0,i=1;i<t.length;i++)if(t[i](e)instanceof calcCell)a+=t[i](e).num(e)/Math.pow(1+r,i);else{var o=0;t[i](e).eachCell(function(){a+=this.num(e)/Math.pow(1+r,i+o),o++})}return n.NumValue(a)},a.FORECAST=function(t,r){for(var a=t[0](r).num(r),i=t[1](r),o=t[2](r),s=[],u=[],l=!1,c=0;c<i.count;c++){if(i.get(c).v(r).errorContext){l=!0;break}s.push(i.get(c).num(r)||0)}for(c=0;c<o.count;c++){if(o.get(c).v(r).errorContext){l=!0;break}u.push(o.get(c).num(r)||0)}l&&console.log("Error in calculating forecast",u,s);for(var h=e(u),f=e(s),g=u.length,d=0,p=0,c=0;c<g;c++)d+=(u[c]-h)*(s[c]-f),p+=Math.pow(u[c]-h,2);var C=d/p,v=f-C*h;return n.NumValue(v+C*a)},a.VALUE=function(t,e){var r=t[0](e).s(e);return n.StringValue(r)},a.LEFT=function(t,e){var r=t[0](e).s(e),a=t[1]&&t[1](e)&&t[1](e).num(e)?t[1](e).num(e):1;return r=r?r.substring(0,a):null,n.StringValue(r)},a.RIGHT=function(t,e){var r=t[0](e).s(e),a=t[1]&&t[1](e)&&t[1](e).num(e)?t[1](e).num(e):1;return r=r?r.substring(r.length-a):null,n.StringValue(r)},a.LEN=function(t,e){var r=t[0](e).s(e);return void 0===r||r.errorContext?n.jsCalcErrorValue(r,e,"Error in calculating length"):"string"==typeof r?n.NumValue(r?r.length:0):r.length?n.NumValue(r.length):n.jsCalcErrorValue(r,e,"Error in calculating length")},a.SUBSTITUTE=function(t,e){var r=t[0](e).s(e),a=t[1]?t[1](e).s(e):"",i=t[2]?t[2](e).s(e):"",o=t[3]?t[3](e).num(e):void 0;if(void 0===r||void 0===a||void 0===i||r.errorContext||a.errorContext||i.errorContext)return n.jsCalcErrorValue(r,e,"Error in substitute function");if(void 0===o){l=r.replace(new RegExp(a,"g"),i);return n.StringValue(l)}for(var s=0,u=0;r.indexOf(a,s)>0;)if(s=r.indexOf(a,s+1),++u===o){var l=r.substring(0,s)+i+r.substring(s+a.length);return n.StringValue(l)}},a.IRR=function(t,e){for(var r=t[0](e),a=t[1]?t[1](e).num(e):0,i=[],o=!1,s=0;s<r.count;s++){if(r.get(s).v(e).errorContext){o=!0;break}i.push(r.get(s).num(e)||0)}if(o)return console.log("Error in calculating IRR"),n.jsCalcErrorValue(r,e,"Error in calculating IRR");for(var u=[],l=!1,c=!1,s=0;s<i.length;s++)u[s]=0===s?0:u[s-1]+365,i[s]>0&&(l=!0),i[s]<0&&(c=!0);if(!l||!c)return n.jsCalcErrorValue(r,e,"Error in calculating IRR");var h,f,g,d=a=void 0===a?.1:a,p=!0;do{h=d-(g=function(t,e,r){for(var n=r+1,a=t[0],i=1;i<t.length;i++)a+=t[i]/Math.pow(n,(e[i]-e[0])/365);return a}(i,u,d))/function(t,e,r){for(var n=r+1,a=0,i=1;i<t.length;i++){var o=(e[i]-e[0])/365;a-=o*t[i]/Math.pow(n,o+1)}return a}(i,u,d),f=Math.abs(h-d),d=h,p=f>1e-10&&Math.abs(g)>1e-10}while(p);return n.NumValue(d)},a.TRIM=function(t,e){var r=t[0](e).s(e);if(void 0===r||r.errorContext)return n.jsCalcErrorValue(r,e,"Error in trimming string");if("string"==typeof r){var a=r.replace(/\s+/g," ");return n.StringValue(a.trim())}return n.jsCalcErrorValue(r,e,"Error in trimming string")},a.INT=function(t,e){var r=Math.floor(t[0](e).num(e));return n.NumValue(r)},a.MOD=function(t,e){var r=t[0](e).num(e)%t[1](e).num(e);return n.NumValue(r)};var u=function(){};window.log||(window.console?window.log=console.log:window.log=function(){}),u.valueFunctions={},u.valueConstructorFunctions={},u.operatorConstructorFunctions={},(u.resultTypes={}).value=0,u.resultTypes.generic=1,u.getEvalFunction=function(t,e,r){var r=!!r;switch(t.type){case"binary":return(a=u.operatorConstructorFunctions[t.operator])(t.A,t.B,e,t);case"value":if("TRUE"==t.value&&alert("Oops!"),u.valueFunctions[t.value])return u.valueFunctions[t.value];var n="number",a=u.valueConstructorFunctions[n];return u.valueFunctions[t.value]=a(t.value),u.valueFunctions[t.value];case"string":if(0==t.value.length){if(u.emptyStringFunction)return u.emptyStringFunction;var n="string",a=u.valueConstructorFunctions[n];return u.emptyStringFunction=a(t.value)}if(u.valueFunctions[t.value])return u.valueFunctions[t.value];var n="string",a=u.valueConstructorFunctions[n];return u.valueFunctions[t.value]=a(t.value),u.valueFunctions[t.value];case"bool":if(u.valueFunctions[t.value])return u.valueFunctions[t.value];var n="bool",a=u.valueConstructorFunctions[n];return u.valueFunctions[t.value]=a(t.value),u.valueFunctions[t.value];case"reference":return u.referenceConstructorFunction(t,e,r);case"namedRangeReference":return u.namedReferenceConstructorFunction(t,e,r);case"wsFunc":return u.worksheetFunctionConstructor(t,e)}},u.valueConstructorFunctions.number=function(t){var e=n.NumValue(parseFloat(t));return function(){return e}},u.valueConstructorFunctions.string=function(t){var e=n.StringValue(t);return function(){return e}},u.valueConstructorFunctions.bool=function(t){var e=n.BooleanValue(t);return function(){return e}},u.operatorConstructorFunctions.add=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){var e=i(t);if(e.errorContext)return e;var r=o(t);return r.errorContext?r:(s.curVal=n.NumValue(e.num(t)+r.num(t)),s.curVal)}},u.operatorConstructorFunctions.sub=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){return s.curVal=n.NumValue(i(t).num(t)-o(t).num(t)),s.curVal}},u.operatorConstructorFunctions.mul=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){i(t),o(t);return s.curVal=n.NumValue(i(t).num(t)*o(t).num(t)),s.curVal}},u.operatorConstructorFunctions.exp=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){var e=i(t).num(t),r=o(t).num(t),a=Math.pow(e,r);return s.curVal=isNaN(a)||a==Number.POSITIVE_INFINITY||a==Number.NEGATIVE_INFINITY?n.ErrorValue(n.jsCalcErrorValue.value,t,"Div0 within exp function"):n.NumValue(a),s.curVal}},u.operatorConstructorFunctions.div=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){i(t).num(t);var e=o(t).num(t);return s.curVal=e?n.NumValue(i(t).num(t)/o(t).num(t)):n.ErrorValue(n.jsCalcErrorValue.divideByZero,t),s.curVal}},u.operatorConstructorFunctions.eq=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){var e=i(t).s(t),r=o(t).s(t);return s.curVal=n.BooleanValue(e==r),s.curVal}},u.operatorConstructorFunctions.neq=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){var e=i(t).s(t),r=o(t).s(t);return s.curVal=n.BooleanValue(e!=r),s.curVal}},u.operatorConstructorFunctions.lt=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){var e=i(t).num(t),r=o(t).num(t);return s.curVal=n.BooleanValue(e<r),s.curVal}},u.operatorConstructorFunctions.gt=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){var e=i(t).num(t),r=o(t).num(t);return s.curVal=n.BooleanValue(e>r),s.curVal}},u.operatorConstructorFunctions.lte=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){var e=i(t).num(t),r=o(t).num(t);return s.curVal=n.BooleanValue(e<=r),s.curVal}},u.operatorConstructorFunctions.gte=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){var e=i(t).num(t),r=o(t).num(t);return s.curVal=n.BooleanValue(e>=r),s.curVal}},u.operatorConstructorFunctions.cat=function(t,e,r,a){var i=u.getEvalFunction(t,r,!0),o=u.getEvalFunction(e,r,!0),s=a;return function(t){var e=i(t).s(t),r=o(t).s(t);return s.curVal=n.StringValue(e+r),s.curVal}},u.namedReferenceConstructorFunction=function(t,e,r){var a=e.workbook,i=t.name;if(i in a.namedRanges){var o=a.namedRanges[i];r&&(o=o.getReferenceAsValueReference(e)),e.parents.push(o)}else window.log("Named range '"+i+"' is referenced in a formula, but is not defined in the workbook.",e.address());var s=t;return function(t){return s.curVal=i in a.namedRanges?a.namedRanges[i]:n.ErrorValue(n.jsCalcErrorValue.nameErr,t),s.curVal}},u.referenceConstructorFunction=function(t,e,r){var a=t.startRow,i=t.startCol,o=t.endRow?t.endRow:a,s=t.endCol?t.endCol:i,l=t.worksheet?t.worksheet:null,c=n.ReferenceValue(a,i,o,s,e,l);return r&&(c=c.getReferenceAsValueReference(e)),e.parents.push(c),u.referenceReturnFunction(c,t)},u.referenceReturnFunction=function(t,e){return function(e){return t}},u.worksheetFunctionConstructor=function(t,e){var r=a[t.name];if(r){var i=[];if(t.argExpressionArray.length)for(var o=0;o<t.argExpressionArray.length;o++){var s=u.getEvalFunction(t.argExpressionArray[o],e);i.push(s)}else i.push(u.getEvalFunction(t.argExpressionArray,e));return u.worksheetFunctionReturnFunction(r,i,e,t)}var l="Unsupported worksheet function in "+e.verboseAddress()+": "+t.name;return e.workbook.buildErrors.push(l),e.workbook.unsupportedFunctionList[t.name]?e.workbook.unsupportedFunctionList[t.name]=e.workbook.unsupportedFunctionList[t.name]+1:e.workbook.unsupportedFunctionList[t.name]=1,e.errorStatus=n.ErrorValue(n.jsCalcErrorValue.build,e,l),function(t){return n.ErrorValue(n.jsCalcErrorValue.build,t,l)}},u.worksheetFunctionReturnFunction=function(t,e,r,n){var a=e,i=t,o=n;return function(t){return o.curVal=i(a,t,n),o.curVal}};var l=function(t,e,r,a,i){this.debugExpressionData=a;var o=this;if(this.workbook=t.parent,this.worksheet=t,this.row=parseInt(e),this.col=parseInt(r),this.parents=[],this.children=[],this.cleanParentCount=0,this.isBlank=0==a,this.breakIf(),a){"value"==a.type||"string"==a.type||"bool"==a.type?(this.workbook.valueCells.push(this),this.isValue=!0):this.isValue=!1,this.errorStatus=null;try{this.expression=u.getEvalFunction(a,this,!0)}catch(t){var s=t;this.workbook.buildErrors.push(t.toString()),this.expression=function(t){return n.ErrorValue(n.jsCalcErrorValue.build,o,s.toString())}}this.errorStatus&&(this.workbook.buildErrors.push("Error building "+this.address()+": "+this.errorStatus.text),this.expression=function(t){return n.ErrorValue(n.jsCalcErrorValue.build,o,"Error building "+o.address())}),this.value=n.ErrorValue(n.jsCalcErrorValue.uninitialized,this,"Not yet initialized"),this.isValue||0!=this.parents.length||this.errorStatus||(this.isValue=!0,this.workbook.valueCells.push(this)),this.isBlank=!1}else{var l={type:"string",value:""};this.isValue=!0,this.isBlank=!0,this.workbook.valueCells.push(this),this.expression=u.getEvalFunction(l,this,!0)}this.isValue&&(this.value=this.expression(this),this.errorStatus=null),this.dirty=!0};l.prototype.reinit=function(t,e){this.debugExpressionData=t;var r=this;if(this.removeParents(),this.cleanParentCount=0,this.workbook.removeValueCell(this),this.isBlank=0==t,this.breakIf(),t){"value"==t.type||"string"==t.type?(this.workbook.valueCells.push(this),this.isValue=!0):this.isValue=!1,this.errorStatus=null;try{this.expression=u.getEvalFunction(t,this,!0)}catch(t){var a=t;this.workbook.buildErrors.push(t.toString()),this.expression=function(t){return n.ErrorValue(n.jsCalcErrorValue.build,r,a.toString())}}this.errorStatus&&(this.workbook.buildErrors.push("Error building "+this.address()+": "+this.errorStatus.text),this.expression=function(t){return n.ErrorValue(n.jsCalcErrorValue.build,r,"Error building "+r.address())}),this.value=n.ErrorValue(n.jsCalcErrorValue.uninitialized,this,"Not yet initialized"),this.isValue||0!=this.parents.length||this.errorStatus||(this.isValue=!0,this.workbook.valueCells.push(this)),this.isBlank=!1}else{var i={type:"string",value:""};this.isValue=!0,this.isBlank=!0,this.workbook.valueCells.push(this),this.expression=u.getEvalFunction(i,this,!0)}this.isValue&&(this.value=this.expression(this),this.errorStatus=null),this.processParents(),this.endirten()},l.prototype.setFromString=function(t){},l.prototype.setValue=function(t){if(t.toString()!=this.value.s(this)&&this.isValue){var e=n.makeValue(t);this.expression=function(){return e},this.value=this.expression(this),this.endirten(),this.workbook.calculationQueue.push(this)}},l.prototype.parentMadeUnclean=function(){this.cleanParentCount--},l.prototype.parentMadeClean=function(){this.cleanParentCount++},l.prototype.endirten=function(){if(!this.dirty){this.dirty=!0;for(var t=0;t<this.children.length;t++)this.children[t].parentMadeUnclean(),this.children[t].endirten()}},l.prototype.processParents=function(){if(this.breakIf(),!this.isValue){for(var t={},e=[],r=0;r<this.parents.length;r++){var n=this.parents[r];if(n)try{n.eachCell(function(){var r=this.address();t.hasOwnProperty(r)||this.isBlank||(e.push(this),t[r]=1)})}catch(t){console.log("Error processing ",t),console.log(n)}}this.parents=e;for(var a=!1,r=0;r<this.parents.length;r++)this.parents[r].addChild(this),a=a||!this.parents[r].isValue;a||this.workbook.valueCells.push(this)}this.parents.length>30&&this.workbook.lotsOfParents.push(this.address()+": "+this.parents.length)},l.prototype.verboseAddress=function(){return this.worksheet.name+"!R"+this.row+"C"+this.col},l.prototype.v=function(){return this.value.v(this)},l.prototype.b=function(){return this.value.b(this)},l.prototype.num=function(){return this.value.num(this)},l.prototype.s=function(){return this.value.s(this)},l.prototype.breakIf=function(){},l.prototype.calculate=function(){if(this.breakIf(),this.dirty){if(this.errorStatus=null,this.value=this.expression(this),this.dirty=!1,this.errorStatus)this.value=this.errorStatus;else this.value.num(this);this.flagChildrenToCalculate()}},l.prototype.flagChildrenToCalculate=function(){for(var t=0;t<this.children.length;t++)this.children[t].parentMadeClean(),this.children[t].flagCalculateIfParentsClean()},l.prototype.flagCalculateIfParentsClean=function(){this.parents.length==this.cleanParentCount&&this.workbook.calculationQueue.push(this)},l.prototype.addParent=function(t){},l.prototype.addChild=function(t){this.children.push(t)},l.prototype.removeParents=function(t){for(var e=0;e<this.parents.length;e++)this.parents[e].removeChild(this)},l.prototype.removeChild=function(t){for(var e=0;e<this.children.length;e++)this.children[e]==t&&this.children.splice(e,1)},l.prototype.address=function(){return this.worksheet.name+"!R"+this.row+"C"+this.col},window.calcCell=l;var c=window.calcCell,h=function(t,e){this.parent=t,this.name=e,this.rows={},this.namedRanges={},this.cellCount=0,this.cellArray=[],this.hierarchyBuildCount=0,this.hierarchyReady=!1};h.prototype.init=function(t){this.initializeNamedRanges(t.namedRanges);for(var e=0;e<t.cells.length;e++)this.addCell(t.cells[e]);for(var r in this.rows)for(var n in this.rows[r])this.cellArray.push(this.rows[r][n])},h.prototype.initializeNamedRanges=function(t){for(var e in t){var r=t[e],a=r.startRow,i=r.startCol,o=r.endRow?r.endRow:a,s=r.endCol?r.endCol:i,u=r.worksheet?r.worksheet:this.name,l=n.ReferenceValue(a,i,o,s,{workbook:this.parent},u);this.namedRanges[e]=l}},h.prototype.addCell=function(t){var e=t.row,r=t.col;this.rows[e]||(this.rows[e]={}),this.rows[e][r]=new c(this,t.row,t.col,t.expression),t.v&&(this.rows[e][r].origValue=t.v),t.f&&(this.rows[e][r].formula=t.f),t.nf&&(this.rows[e][r].nf=t.nf),this.cellCount++},h.prototype.getCell=function(t,e){return this.rows[t]&&this.rows[t][e]?this.rows[t][e]:(this.rows[t]||(this.rows[t]={}),this.rows[t][e]=new c(this,t,e,null,!0),this.rows[t][e])},h.prototype.initializeHierarchies=function(){for(var t in this.rows)for(var e in this.rows[t])this.rows[t][e].processParents();this.hierarchyReady=!0},h.prototype.initializeSingleCellHierarchyAsync=function(){this.hierarchyBuildCount<this.cellArray.length?(this.cellArray[this.hierarchyBuildCount].processParents(),this.hierarchyBuildCount++):(this.hierarchyReady=!0,this.parent.numBuilt--)};for(var f=0,g=["webkit","moz"],d=0;d<g.length&&!window.requestAnimationFrame;++d)window.requestAnimationFrame=window[g[d]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[g[d]+"CancelAnimationFrame"]||window[g[d]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,e){var r=(new Date).getTime(),n=Math.max(0,16-(r-f)),a=window.setTimeout(function(){t(r+n)},n);return f=r+n,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});var p={};p.range1Regex=/^(?:([a-zA-Z\_\-0-9]*)\!)?\$?([a-zA-Z]{1,2})\$?([1-9][0-9]*)(?::\$?([a-zA-Z]{1,2})\$?([1-9][0-9]*))?$/i,p.rangeRCRegex=/^(?:([a-zA-Z\_\-0-9]*)\!)?\$?R([1-9][0-9]*)\$?C([1-9][0-9]*)(?::\$?R([1-9][0-9]*)\$?C([1-9][0-9]*))?$/i,p.rangeColRegex=/^(?:([a-zA-Z\_\-0-9]*)\!)?\$?([a-zA-Z]{1,2})(?::\$?([a-zA-Z]{1,2}))?$/i,p.rangeRowRegex=/^(?:([a-zA-Z\_\-0-9]*)\!)?\$?([1-9][0-9]*)(?::\$?([1-9][0-9]*))?$/i,p.rangeMultiRegex=/^(?:([a-zA-Z\_\-0-9]*)\!)?\$?([a-zA-Z]{1,2})\$?([1-9][0-9]*)(?::\$?([a-zA-Z]{1,2})\$?([1-9][0-9]*))(\,(?:([a-zA-Z\_\-0-9]*)\!)?\$?([a-zA-Z]{1,2})\$?([1-9][0-9]*)(?::\$?([a-zA-Z]{1,2})\$?([1-9][0-9]*)))+?$/i,p.getRCColumn=function(t){for(var e="A".charCodeAt(0)-1,r=1,n=0,a=t.length-1;a>=0;a--)n+=(t.charCodeAt(a)-e)*r,r*=26;return n},p.getRangeOb=function(t){if(p.rangeRCRegex.test(t)){var e={},r=p.rangeRCRegex.exec(t);return e.sheetName=r[1],e.startRow=r[2],e.startCol=r[3],e.endRow=r[4]?r[4]:e.startRow,e.endCol=r[5]?r[5]:e.startCol,e}if(p.range1Regex.test(t)){var n=p.range1Regex.exec(t);if(!n){if(p.rangeMultiRegex.test(t)){for(var a=t.split(","),i=[],o=0;o<a.length;o++){var s=p.getRangeOb(a[o]);s&&i.push(s)}return i}if(p.rangeColRegex.test(t)){e={};return(n=p.rangeColRegex.exec(t))[1]&&(e.sheetName=n[1]),e.startCol=parseInt(n[2]),e.endCol=parseInt(n[3]),e.startRow=1,e.endRow=65e3,e}if(p.rangeRowRegex.test(t)){e={};return(n=p.rangeRowRegex.exec(t))[1]&&(e.sheetName=n[1]),e.startRow=parseInt(n[2]),e.endRow=parseInt(n[3]),e.startCol=1,e.endCol=216,e}return void p.errorLog.push("Error attempting to parse address: "+t)}e={};return n[1]&&(e.sheetName=n[1]),e.startCol=parseInt(p.getRCColumn(n[2].toUpperCase())),e.startRow=parseInt(n[3]),n[4]&&(e.endCol=parseInt(p.getRCColumn(n[4].toUpperCase())),e.endRow=parseInt(n[5])),e}};var C=function(t){this.init(t)};C.prototype.init=function(t){if(t||(t={}),this.calculationBreakpointObject=null,t.modelJSON&&(this.workbookJson=t.modelJSON),this.nextAnimFrame&&window.cancelAnimationFrame(this.nextAnimFrame),!this.workbookJson)return-1;this.buildAsync=!!t.buildAsync,this.buildProgressCallback=t.buildProgressCallback,this.name=this.workbookJson.name,this.buildErrors=[],this.calculationErrors=[],this.namedRanges={},this.worksheets={},this.valueCells=[],this.animFrameTimes=[],this.unsupportedFunctionList={},this.calcCB=null,this.calculationTimePerFrame=20,this.cellCount=0,this.queueEmpty=!0,this.startTime=0,this.endTime=0,this.calcTimeElapsed=0,this.calcCount=0,this.buildStartTime=(new Date).getTime(),this.buildQueue=[],this.buildStage=0,this.numBuilt=0,this.lotsOfParents=[],this.buildMessage="Reticulating Splines",this.addressReference={},u.activeWorkbook=this;var e,r=this;for(e in this.workbookJson.worksheets)this.worksheets[e]=new h(this,e);if(this.initializeNamedRanges(this.workbookJson.namedRanges),this.buildAsync){this.buildQueue.push({buildFunc:function(){r.buildStage=1,r.numBuilt=0,r.buildQueueOrigLength=r.cellCount+1,r.buildMessage="Building Cell Calculation Functions"}});for(e in this.workbookJson.worksheets)this.buildQueue.push({buildFunc:function(t){r.worksheets[t].init(r.workbookJson.worksheets[t]),r.cellCount+=r.worksheets[t].cellCount},args:e});this.buildQueue.push({buildFunc:function(){r.buildStage=1,r.numBuilt=0,r.buildQueueOrigLength=r.cellCount+1,r.buildMessage="Calculating cell hierarchies"}});for(e in this.workbookJson.worksheets)this.buildQueue.push({buildFunc:function(t,e){r.asynchHierarchyBuildFunc(t,e)},args:e});this.buildQueue.push({buildFunc:function(){r.calculationQueue=r.valueCells.slice(0),r.nextAnimFrame=window.requestAnimationFrame(function(){r.processCalculation()})}}),this.nextAnimFrame=window.requestAnimationFrame(function(){r.asyncBuildWorkbook()}),this.buildQueueOrigLength=this.buildQueue.length}else{for(e in this.workbookJson.worksheets)this.worksheets[e].init(this.workbookJson.worksheets[e]),this.cellCount+=this.worksheets[e].cellCount;for(e in this.workbookJson.worksheets)this.worksheets[e].initializeHierarchies();this.calculationQueue=this.valueCells.slice(0);r=this;this.nextAnimFrame=window.requestAnimationFrame(function(){r.processCalculation()})}},C.prototype.asynchHierarchyBuildFunc=function(t,e){this.worksheets[t].initializeSingleCellHierarchyAsync(),this.worksheets[t].hierarchyReady||this.buildQueue.unshift(e)},C.prototype.asyncBuildWorkbook=function(){for(var t=(new Date).getTime();(new Date).getTime()-t<=this.calculationTimePerFrame&&this.buildQueue.length>0;){var e=this.buildQueue.shift();this.numBuilt++,e.buildFunc(e.args,e)}if(this.buildProgressCallback){var r={numComplete:this.numBuilt,numTotal:this.buildQueueOrigLength,message:this.buildMessage+" ("+this.numBuilt+"/"+this.buildQueueOrigLength+")",curStage:this.buildStage};this.buildProgressCallback(r)}var n=this;this.buildQueue.length>0?this.nextAnimFrame=window.requestAnimationFrame(function(){n.asyncBuildWorkbook()}):(this.calculationQueue=this.valueCells.slice(0),this.nextAnimFrame=window.requestAnimationFrame(function(){n.processCalculation()}))},C.prototype.calculationPending=function(){return this.calculationQueue.length>0},C.prototype.processCalculation=function(){var t=(new Date).getTime();if(this.calculationQueue.length>0){for(this.queueEmpty&&(this.startTime=(new Date).getTime(),this.endTime=0,this.calcTimeElapsed=0,this.calcCount=0,this.queueEmpty=!1);(new Date).getTime()-t<=this.calculationTimePerFrame&&this.calculationQueue.length>0;){var e=this.calculationQueue.shift();try{e.calculate()}catch(t){this.calculationErrors.push(e.address()+": "+t.message);var r=n.ErrorValue(n.jsCalcErrorValue.calc,e,t.message);e.errorStatus=r}this.calcCount++}0==this.calculationQueue.length&&(this.endTime=(new Date).getTime(),this.calcTimeElapsed=this.endTime-this.startTime,this.queueEmpty=!0,this.calcCB&&(this.calcCBOb?this.calcCB.call(this.calcCBOb):this.calcCB()))}var a=this;this.nextAnimFrame=window.requestAnimationFrame(function(){a.processCalculation()})},C.prototype.forceCalculate=function(){this.startTime=(new Date).getTime(),this.calcCount=0;for(;this.calculationQueue.length>0&&(new Date).getTime()-this.startTime<2e4;)this.calculationQueue.shift().calculate(),this.calcCount++,0==this.calculationQueue.length&&(this.endTime=(new Date).getTime(),this.calcTimeElapsed=this.endTime-this.startTime,this.calcCB&&(this.calcCBOb?this.calcCB.call(this.calcCBOb):this.calcCB()))},C.prototype.onCalculationDone=function(t){t.length&&t.length>=2&&"function"==typeof t[1]?(this.calcCBOb=t[0],this.calcCB=t[1]):(this.calcCBOb=null,this.calcCB=t)},C.prototype.initializeNamedRanges=function(t){for(var e in t){var r=t[e],a=r.startRow,i=r.startCol,o=r.endRow?r.endRow:a,s=r.endCol?r.endCol:i,u=r.worksheet?r.worksheet:null,l=n.ReferenceValue(a,i,o,s,{workbook:this},u),c=a===o&&i===s?u+"!R"+a+"C"+s:u+"!R"+a+"C"+a+":R"+o+"C"+s;this.namedRanges[e]=l,this.addressReference[c]=e}},C.prototype.getRangeReferenceByAddress=function(t){return n.ReferenceValue(t.startRow,t.startCol,t.endRow,t.endCol,{workbook:this},t.sheetName)},C.prototype.getRange=function(t){if(this.namedRanges[t])return this.namedRanges[t];var e=p.getRangeOb(t);return this.getRangeReferenceByAddress(e)},C.prototype.getFriendlyName=function(t){var e=this;return void 0!==e.addressReference[t]?e.addressReference[t]:null},C.prototype.getNames=function(t){var e=[];for(var r in this.namedRanges)"RegExp"==typeof t&&t.test(r)&&e.push(r);return e},C.prototype.getValue=function(t){var e=null;if(this.isNamedRange(t))e=this.getRange(t);else if(p.range1Regex.test(t)||p.rangeRCRegex.test(t)){var r=p.getRangeOb(t);e=this.getRangeReferenceByAddress(r)}if(!e)return-1;if(1==e.count)return e.getSingleCellReference().v();var n=[];return e.eachCell(function(){n.push(this.v())}),n},C.prototype.removeValueCell=function(t){for(var e=0;e<this.valueCells.length;e++)if(this.valueCells[e]==t)return void this.valueCells.splice(e,1)},C.prototype.getContextualValue=function(t,e){var r=null;if(this.isNamedRange(t))r=this.getRange(t);else if(p.range1Regex.test(t)||p.rangeRCRegex.test(t)){var n=p.getRangeOb(t);r=this.getRangeReferenceByAddress(n)}return r?1==r.count?r.getSingleCellReference().v(e):r.v(e):-1},C.prototype.isNamedRange=function(t){return t in this.namedRanges},C.prototype.isWorksheet=function(t){return t in this.worksheets},C.prototype.recalculate=function(t){for(var e=0;e<this.valueCells.length;e++)this.valueCells[e].endirten();this.calculationQueue=this.valueCells.slice(0)};var v=require("numeral");window.isArray||(window.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var m=function(t){this.versionNumber=.022,this.periodName=t.hasOwnProperty("periodName")?t.periodName:"xxYear",this.curPeriod=-1,this.loadCallback=t.loadCallback,this.buildProgressCallback=t.buildProgressCallback?t.buildProgressCallback:null,this.modelURL=t.modelURL?t.modelURL:null,this.model=t.model?t.model:null,this.buildAsync=!t.hasOwnProperty("buildAsync")||t.buildAsync,this.workbook=null,this.ready=!1,this.calculationCallbacks=[],this.singletonCalculationCallbacks=[],this.courseActions=t.customActions?t.customActions:null,this.stateVariables={},this.historicalData={};var e=this;this.modelURL&&this.loadCallback?($.ajax({url:this.modelURL,dataType:"json",complete:function(t){e.model=t.responseJSON,e.buildFromJSON()},error:r}),this.initialized=!0):this.model&&this.loadCallback&&(this.buildFromJSON(),this.initialized=!0)};return m.prototype.onNextRecalculate=function(t){this.singletonCalculationCallbacks.push(t)},m.prototype.completeCalculation=function(){var t=this;return new Promise(function(e,r){!t.workbook.calculationPending()&&t.ready?e():t.singletonCalculationCallbacks.push(function(){t.completeCalculation().then(e)})})},m.prototype.buildFromJSON=function(t){e=this;this.workbook=new C({modelJSON:this.model,buildProgressCallback:function(t){e.onBuildProgress(t)},buildAsync:this.buildAsync});var e=this;this.workbook.onCalculationDone(function(){e.curPeriod=e.getRawValue(e.periodName),e.workbook.onCalculationDone([e,m.onCalculationDone]),e.loadCallback()}),this.ready=!0},m.prototype.reset=function(t){e=this;this.ready=!1,t=t||{},this.loadCallback=t.loadCallback,this.buildProgressCallback=t.buildProgressCallback?t.buildProgressCallback:null,this.workbook.init({buildProgressCallback:function(t){e.onBuildProgress(t)},buildAsync:this.buildAsync});var e=this;this.workbook.onCalculationDone(function(){e.workbook.onCalculationDone([e,m.onCalculationDone]),e.ready=!0,e.loadCallback()})},m.prototype.setValue=function(t,e){var r=this.getRangeRef(t);if(!r||!r.targetSheetOb)return Promise.reject("Cannot set value: "+e+". No valid range found for: "+t);if(window.isArray(e)){for(var n=r.h>e.length?e.length:r.h,a=0;a<n;a++)if(window.isArray(e[a]))for(var i=r.w>e[a].length?e[a].length:r.w,o=0;o<i;o++){var s=r.startRow+a,u=r.startCol+o,l=r.targetSheetOb.name+"!R"+s+"C"+u;this.setValue(l,e[a][o])}}else{var c=r.targetSheetOb.name+"!R"+r.startRow+"C"+r.startCol;if(null==e&&(e=""),"string"==typeof e){var h=parseFloat(e);isNaN(h)||isNaN(Number(e))||(e=h)}this.stateVariables[c]=e,r.get(0).setValue(e)}return this.completeCalculation()},m.prototype.getRawValue=function(t){var e=this.getRangeRef(t);if(!e)return null;var r=e.valueArray();return 1==r.length&&1==r[0].length?r[0][0]:r},m.prototype.getValue=function(t,e){if(0!=e&&void 0!==e&&e.toString()!=this.curPeriod.toString())return e<0&&(e=this.curPeriod+e),this.getHistoricalValue(t,e);var r=this.getRangeRef(t);if(!r)return null;if(1==r.h&&1==r.w){var n=r.getSingleCellReference(),a=n.nf,i=n.v();if(isNaN(parseFloat(i)))return i;var o=a;return"General"==a&&(o="0,0"),v(i).format(o)}return r.valueArray()},m.prototype.getHistoricalValue=function(t,e){return this.historicalData[e]&&this.historicalData[e].hasOwnProperty(t)?this.historicalData[e][t]:"N/A"},m.prototype.getSeriesValue=function(t,e){if(0!=e&&void 0!==e&&e.toString()!=this.curPeriod.toString()){e<0&&(e=this.curPeriod+e);u=this.getHistoricalValue(t,e);if(!window.isArray(u))return[u];for(var r=[],n=0;n<u.length;n++){var a=u[n];if(window.isArray(a))for(var i=0;i<a.length;i++){var o=a[i];r.push(o)}else r.push(a)}return r}var s=this.getRangeRef(t);if(!s)return null;if(1==s.h&&1==s.w)return[s.getSingleCellReference().v()];var u=[];return s.eachCell(function(){u.push(this.v())}),u},m.prototype.addCalculationCallback=function(t){for(var e=!1,r=0;r<this.calculationCallbacks.length;r++)m.cbCompare(this.calculationCallbacks[r],t)&&(e=!0);e||this.calculationCallbacks.push(t)},m.prototype.removeCalculationCallback=function(t){for(var e=0;e<this.calculationCallbacks.length;e++)m.cbCompare(this.calculationCallbacks[e],t)&&(this.calculationCallbacks.splice(e,1),e--)},m.prototype.runCourseAction=function(t){var e=this;return new Promise(function(r,n){e.courseActions[t]?e.courseActions[t].call(e).then(function(){r()}):n()})},m.prototype.getFullState=function(){var t={};t.cells={};for(var e in this.stateVariables){var r=this.getRawValue(e);t.cells[e]=r.toString()}return t.historicalData=this.historicalData,t},m.prototype.getState=function(){var t={};t={};for(var e in this.stateVariables){var r=this.getRawValue(e);t[e]=r.toString()}return t},m.prototype.getHistoricalState=function(){var t={};return t.cells={},t=this.historicalData},m.prototype.getJSONState=function(){return JSON.stringify(this.getState())},m.prototype.setState=function(t,e,r){var n={};n.cells=t,n.historicalData=void 0===e||null===e?{}:e;var a=r;this.reset({loadCallback:function(){for(cellAddress in n.cells)this.getRangeRef(cellAddress).get(0).setValue(n.cells[cellAddress]);this.historicalData=n.historicalData,this.stateVariables=n.cells,a&&a()}})},m.prototype.setJSONState=function(t,e){var r=JSON.parse(t);this.setState(r,e)},m.prototype.copyAndPasteByValue=function(t,e){var r=this.getRangeRef(t),n=this.getRangeRef(e);if(!r||!n)return-1;if(1==r.count)for(var a=r.getSingleCellReference().v(),i=0;i<n.count;i++)this.setValue(n.get(i).getSingleCellReference().address(),a);else for(var o=n.getSingleCellReference(),s=0;s<r.h;s++)for(var u=0;u<r.w;u++){var l=o.row+s,c=o.col+u,h=o.worksheet.name+"!R"+l+"C"+c,a=r.getCellByIndex(s,u).v();this.setValue(h,a)}},m.prototype.isNamedRange=function(t){return this.workbook.isNamedRange(t)},m.onCalculationDone=function(){this.curPeriod=this.getRawValue(this.periodName);for(t=0;t<this.singletonCalculationCallbacks.length;t++)(e=this.singletonCalculationCallbacks[t]).length>=2&&"function"==typeof e[1]?e[1].call(e[0]):e();this.singletonCalculationCallbacks=[];for(var t=0;t<this.calculationCallbacks.length;t++){var e=this.calculationCallbacks[t];e.length>=2&&"function"==typeof e[1]?e[1].call(e[0]):e()}},m.prototype.getRangeRef=function(t){var e=null;if(this.workbook.isNamedRange(t))e=this.workbook.getRange(t);else if(p.range1Regex.test(t)||p.rangeRCRegex.test(t)){var r=p.getRangeOb(t);e=this.workbook.getRangeReferenceByAddress(r)}return e},m.prototype.setBuildProgressCallback=function(t){this.buildProgressCallback=t},m.prototype.onBuildProgress=function(t){this.buildProgressCallback&&this.buildProgressCallback(t)},m.cbCompare=function(t,e){return"function"==typeof t&&"function"==typeof e?t==e:!!(window.isArray(t)&&window.isArray(e)&&t.length>=2&&e.length>=2)&&(t[0]==e[0]&&t[1]==e[1])},m.prototype.saveCurrentPeriodHistoricalData=function(t){for(var e=t||"xxYear",r=this.getValue(e),n=/^tlOutput.*$/i,a=this.workbook.getNames(n),i={},o=0;o<a.length;o++){var s=a[o];i[s]=this.getValue(s),"object"!=typeof i[s]||window.isArray(i[s])||(i[s]=i[s].data)}this.historicalData[r]=i},m.prototype.getErrorList=function(){for(var t=this.workbook.getNames("."),e=0;e<t.length;e++){var r=t[e];"#UNINITIALIZED!"==this.getValue(r)&&console.log(r+" = "+this.getValue(r))}},m.prototype.getBook=function(){return this.workbook},m.prototype.isNamedRange=function(t){return this.workbook.isNamedRange(t)},m.prototype.getFriendlyRangeName=function(t){return this.workbook.getFriendlyName(t)},m.prototype.getNames=function(t){return this.workbook.getNames(t)},m.prototype.addCourseActionBlock=function(t){for(actionName in t)this.addCourseAction(actionName,t[actionName])},m.prototype.addCourseAction=function(t,e){this.courseActions[actionName]=e},m})});
//# sourceMappingURL=jsCalc.min.js.map
